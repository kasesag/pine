# Supfile
version: 0.4
commands:
  ostree-containerpilot:
    desc: sets up a ref for containerpilot
    run: |
      copi_path=/usr/bin/containerpilot
      copi_root=/var/tmp/copi
      [ -f $copi_path ] || exit 1
      mkdir -p $copi_root
      cp -a $copi_path $copi_root
      $ostree commit -b copi $copi_root
      rm -rf $copi_root
  consul-agent-start:
    desc: start the consul service
    run: |
      rc-update add consul default
      setcap 'cap_net_bind_service=+ep' $(realpath $(which consul))
      rc-service consul start
  consul-install:
    desc: install consul binaries
    local: |
      . /etc/profile.d/func.sh
      grep testing /opt/alp/etc/apk/repositories || \
      echo "http://dl-cdn.alpinelinux.org/alpine/edge/testing" >> /opt/alp/etc/apk/repositories
      apkc /opt/alp add consul
      mkdir -p /opt/bin
      ln -s /opt/alp/usr/sbin/consul /opt/bin/
      [ ! -d /etc/consul ] && cp -a /opt/alp/etc/consul /etc
      [ ! -f /etc/conf.d/consul ] && cp -a /opt/alp/etc/conf.d/consul /etc/conf.d
      cp -a /opt/alp/etc/init.d/consul /etc/init.d/
      id consul || adduser -D consul
      sed -r 's$/usr/sbin$/opt/bin$' -i /etc/init.d/consul
      sed -r 's$consul validate$/opt/bin/consul validate$' -i /etc/init.d/consul
      setcap 'cap_net_bind_service=+ep' $(realpath /opt/bin/consul) 
      chown consul:consul -R /etc/consul
      chmod +x /opt/bin/consul
  consul-node-config:
    desc: configure consul node settings
    run: |
      mkdir -p /var/consul && chown consul:consul -R /var/consul
      echo "CONSUL_HTTP_ADDR=http://\$IPv4:8500" >> /etc/network-environment
      echo -e "nameserver ${IPv4}\n$(cat /etc/resolv.conf)" > /etc/resolv.conf
      cat <<EOF >/etc/consul/node.json
      {
        "node_name": "$NODE",
        "datacenter": "${DC:-global}",
        "advertise_addr": "$IPv4",
        "client_addr": "$IPv4",
        "bind_addr": "$IPv4",
        "domain": "cluster.${FQN}",
        "ports": {
          "dns": ${DNS_PORT:-53}
        },
        "recursors": [ "1.1.1.1", "8.8.8.8" ],
        "log_rotate_bytes": 131072,
        "log_rotate_max_files": 3,
        "log_rotate_duration": "11h"
      }
      EOF
  consul-encrypt:
    desc: enable consul cluster gossip encryption
    local: |
      enckey=$(consul keygen)
      cat <<EOF >/etc/consul/encrypt.json
      {
          "encrypt": "$enckey"
      }
      EOF
  consul-encrypt-upload:
    desc: upload keys to the cluster
    upload:
    - src: /etc/consul/encrypt.json
      dst: /
  consul-join:
    desc: joins the leaders in a consul cluster
    local: |
      consul join $(cat $leadlist | grep -oE "^[^:]*")
