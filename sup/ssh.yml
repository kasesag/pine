# Supfile
version: 0.4
commands:
  ssh-checks:
    desc: ssh bootstrapping sanity checks
    local: |
      [ -z "$PORT" ] && echo "PORT is empty." && exit 1 || true
  ssh-clear-key:
    desc: clear local keys, for bootstrapping
    local: |
      rm -f ~/.ssh/{authorized_keys,id_rsa,id_dropbear}
  ssh-pub-key:
    desc: generate ssh key
    local: |
      mkdir -p ~/.ssh
      [ -f ~/.ssh/id_dropbear -o -f ~/.ssh/id_rsa ] && echo "ppk files present...terminating." && exit 1
      dropbearkey -t rsa -f ~/.ssh/id_dropbear &>/dev/null
      echo 'command="exec /usr/bin/ssheval" '$(\
      dropbearkey -y -f ~/.ssh/id_dropbear | grep -o "^ssh-rsa [^ ]*") >> ~/.ssh/authorized_keys
      which dropbearconvert 1>/dev/null || ( ostree admin unlock 2>/dev/null ; apk add --no-cache dropbear-convert 2>/dev/null )
      dropbearconvert dropbear openssh ~/.ssh/id_dropbear ~/.ssh/id_rsa
      echo "the pub key is:"
      cat ~/.ssh/authorized_keys | tail -1 | sed -r 's/(command=".*")?[^ ]* ssh-rsa ([^ ]*).*/\2/'
      echo "the private key is:"
      cat ~/.ssh/id_rsa
  ssh-dist-key:
    desc: distribute pub key to each node of NETWORK_LIST (defaults to /etc/workers), cause upload task does not support keyless auths...
    local: |
      SUP_NETWORK_CHECK=$SUP_NETWORK
      sup local $SUP_ENV network-local-check
      DROPBEAR_PASSWORD=${rootppp:-$DROPBEAR_PASSWORD}
      for w in $(cat ${NETWORK_LIST:-$worklist}) ; do
        echo $w
        a=$(echo "$w" | sed -r 's/:[0-9]+$//' )
        p=$(echo "$w" | sed -r 's/[^:]*(:([0-9]+))?/\2/')
        [ -n "$p" ] && { Pf="-P" pf="-p"; } || { Pf= pf=; }
        ssh $pf $p $a "mkdir -p \$HOME/.ssh"
        scp -r $Pf $p ~/.ssh/authorized_keys $a:$HOME/.ssh/authorized_keys
      done
  ssh-dropbear-config:
    desc: dropbear daemon args
    run: |
      sed -r 's/(DROPBEAR_OPTS=).*/\1"-s -p '${PORT:-2468}' -W '${WSIZE:-512K}'"/' -i /etc/conf.d/dropbear;
      /sbin/rc-service dropbear restart
  ssh-hosts-port:
    desc: changes the ssh port of a list of networks (files) and restart dropbear
    local: |

      for inv in $inventories; do
        sed -r 's/(:([1-9]|[1-8][0-9]|9[0-9]|[1-8][0-9]{2}|9[0-8][0-9]|99[0-9]|\
        [1-8][0-9]{3}|9[0-8][0-9]{2}|99[0-8][0-9]|999[0-9]|[1-5][0-9]{4}|\
        6[0-4][0-9]{3}|65[0-4][0-9]{2}|655[0-2][0-9]|6553[0-5])$)|:$|$/:'$PORT'/' -i $inv
      done
  ssh-wrap:
    desc: disable root pass logins and changes ssh port on dropbear
    run: |
      sup -f $SUP_FILE -e PORT=$PORT $SUP_ENV ${NETWORK:-cluster} ssh-dropbear-config
