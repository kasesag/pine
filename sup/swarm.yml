# Supfile
version: 0.4

commands:
  swarm-init:
    desc: the first command to initialize the swarm on the leader, for network leaders
    run: |
      sup -f $SUP_FILE -e SUP_NETWORK_CHECK=$SUP_NETWORK local network-leader-check
      mkdir -p /tmp/swarm-init
      IP=$(echo "$SUP_HOST" | sed -r 's/:[0-9]+$//')
      docker swarm init --advertise-addr=$IP | grep -Eo '.*\\$' -A 1 > /tmp/swarm-init/cmd
      sup -f $SUP_FILE $SUP_ENV workers swarm-join-upload
      sup -f $SUP_FILE $SUP_ENV workers swarm-join-node
    once: true
  swarm-join-upload:
    desc: upload join command to worker nodes, because variables are troublesome
    upload:
    - src: /tmp/swarm-init
      dst: /
  swarm-join-node:
    desc: unwrap the docker command to join nodes to the swarm
    run: |
      sup -f $SUP_FILE -e SUP_NETWORK_CHECK=$SUP_NETWORK local network-worker-check
      chmod +x /tmp/swarm-init/cmd
      /bin/sh /tmp/swarm-init/cmd
  swarm-disband:
    desc: disjoin a docker swarm
    run: |
      sup -f $SUP_FILE -e SUP_NETWORK_CHECK=$SUP_NETWORK local network-leader-check
      sup -f $SUP_FILE $SUP_ENV workers swarm-worker-leave
      docker node ls -f role=worker -q | xargs -I {} docker node update {}
      docker swarm leave -f
  swarm-worker-leave:
    run: |
      sup -f $SUP_FILE -e SUP_NETWORK_CHECK=$SUP_NETWORK local network-worker-check
      docker swarm leave
